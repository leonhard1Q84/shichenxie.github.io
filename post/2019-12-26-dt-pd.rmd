---
title: data.table 与 pandas
author: shichen xie
date: '2019-12-26'
slug: dt-pd
tags: ['R', 'python']
output:
  blogdown::html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

常见的数据分析项目过程包括加载数据-清洗数据-(特征处理、可视化、模型模拟)-交流成果。其中，清洗数据与特征处理一般占据整个项目的大部分时间。熟练掌握相关工具，提高数据处理的效率,是数据分析工作的基础。
![](https://d33wubrfki0l68.cloudfront.net/571b056757d68e6df81a3e3853f54d3c76ad6efc/32d37/diagrams/data-science.png)

数据框（data frame）是我们接触最多的数据形式，其每一列都是向量且长度一致。在 R 中我通常使用 data.table 包对数据框进行处理分析，而在 python 环境中 pandas 最为常用的。根据 [Database-like ops benchmark](https://h2oai.github.io/db-benchmark/) 显示，data.table 在大部分任务中性能表现最好，而且其语法也相对简洁统一。为了方便大家对比学习，本文将分别用 [data.table](http://r-datatable.com) 与 [pandas](https://pandas.pydata.org/pandas-docs/stable/) 实现常见的数据分析任务[^1][^2]。

[^1]: [Data Manipulation with Python Pandas and R Data.Table](https://datascience-enthusiast.com/R/pandas_datatable.html)
[^2]: [R for Data Science](https://r4ds.had.co.nz/)

### 探索数据
#### 读取 csv 文件
<div class="row">
<div class='column-left'>
```{r}
library(data.table)
packageVersion('data.table')

url = "https://vincentarelbundock.github.io/Rdatasets/csv/datasets/HairEyeColor.csv"
dt = fread(url)
```
</div>
<div class='column-right'>
```{python}
import pandas as pd
pd.__version__

url = "https://vincentarelbundock.github.io/Rdatasets/csv/datasets/HairEyeColor.csv"
df = pd.read_csv(url)
```
</div>
</div>
#### 查看数据结构
<div class="row">
<div class='column-left'>
```
#数据类型
class(dt)
str(dt)

# 列名
names(dt)
# 打印前后几行
head(dt, n=3)
tail(dt, n=3)

# 维度
dim(dt)
nrow(dt)
ncol(dt)

# 汇总
summary(dt)
```
</div>
<div class='column-right'>
```
#数据类型
type(df)
df.dtypes

# 列名
list(df)
# 打印前后几行
df.head(n=3)
df.tail(n=3)

# 维度
df.shape
len(df.index)
len(df.columns)

# 汇总
df.describe()
```
</div>
</div>

### 行选择与排序
#### rows filter
<div class="row">
<div class='column-left'>
```
# 基于行所在位置筛选
dt[c(3,1,2)]


# 单条件筛选
dt[Hair == 'Red']

# 多条件筛选
dt[Hair == 'Black' & 
   Freq >= 10 & 
   Eye %in% c('Brown', 'Blue')]

```
</div>
<div class='column-right'>
```
# 基于行所在位置筛选, 换成.loc则基于index筛选
df.iloc[[2,0,1]] 
df.loc[[2,0,1]] # 如果index未修改，效果一致

# 单条件筛选，去掉.loc效果一致
df.loc[df['Hair'] == 'Red'] 

# 多条件筛选时要用|, &,~分别代表or,and,not; 且每个条件用括号区分 
df.loc[(df['Hair'] == 'Black') & 
       (df['Freq'] >= 10) & 
       (df['Eye'].isin(['Brown', 'Blue']))]
```
</div>
<!-- https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#boolean-indexing -->
#### rows arrange
<div class="row">
<div class='column-left'>
```
dt[order(Sex, -Freq)]
```
</div>
<div class='column-right'>
```
df.sort_values(['Sex', 'Freq'], ascending=[True, False])
```
</div>
</div>

### 列选择、新建与计算
#### columns select
<div class='row'>
<div class='column-left'>
```
dt[,.(Hair, Freq)]
# or 
dt[,c('Eye', 'Sex'), with=FALSE]
```
</div>
<div class='column-right'>
```
df[['Hair', 'Freq']]
# or 
df.loc[:,['Eye', 'Sex']]
```
</div>
</div>

#### columns mutate
<div class="row">
<div class='column-left'>
```{r}
# 新建一列
dt[, nc := 1:32]
dt[,'nc0'] = 1:32

# 新建多列
dt[, `:=`(
  nc1 = 1:32,
  nc2 = paste0(Hair, Eye)
)]

# 基于条件新建列
dt[, nc3 := ifelse(Freq >= 10, 1, 0)]
dt[Freq >= 20, nc4 := 2]

# 删除列
dt[, nc := NULL]
dt[, (c('nc0', 'nc1', 'nc2', 'nc3','nc4')) := NULL]
```
</div>
<div class='column-right'>
```{python}
# 新建一列
df.loc[:,'nc'] = pd.Series(range(32), index=df.index)
df = df.assign(nc0 = pd.Series(range(32)))

# 新建多列
df = df.assign(
  nc1 = pd.Series(range(32)),
  nc2 = df.Hair + df.Eye
)

# 基于条件新建列
df = df.assign(nc3 = df.apply(lambda x: 1 if x.Freq >= 10 else 0, axis=1))
df.loc[df.Freq >= 20, 'nc4'] = 2

# 删除列
df = df.drop('nc', axis=1)
df.drop(['nc0','nc1','nc2','nc3','nc4'], axis=1, inplace=True)
```
</div>
</div>

#### columns summarise
<div class="row">
<div class='column-left'>
```
# 基于列的计算
dt[, unique(Eye)]
dt[, table(Eye)]

dt[, max(Freq)]
```
</div>
<div class='column-right'>
```
# 基于列的计算
df.Eye.unique()
df.Eye.value_counts()

df.Freq.max()
```
</div>
</div>


### 分组汇总计算
#### grouped summarise
<div class="row">
<div class='column-left'>
```
# max freq
dt[, .(freq_max = max(Freq)), by = 'Sex']

# count
dt[, .(freq_count = .N), keyby = c('Hair', 'Sex')]
```
</div>
<div class='column-right'>
```
# max freq # pandas的groupby会自动删除缺失变量
df.groupby('Sex').agg({'Freq':'max'}).rename(columns={'Freq':'freq_max'})

# count
df.groupby(['Hair', 'Sex']).agg({'Freq':'count'}).rename(columns={'Freq':'freq_count'})
```
</div>
</div>
#### grouped mutate & filter
<div class="row">
<div class='column-left'>
```{r}

```
</div>
<div class='column-right'>
```{python}

```
</div>
</div>

### 行列转换
#### 长宽表转换
<div class="row">
<div class='column-left'>
```{r}

```
</div>
<div class='column-right'>
```{python}

```
</div>
</div>
#### 多行合并切割
<div class="row">
<div class='column-left'>
```{r}

```
</div>
<div class='column-right'>
```{python}

```
</div>
</div>

### 数据框合并 merge/join
<div class="row">
<div class='column-left'>
```{r}

```
</div>
<div class='column-right'>
```{python}

```
</div>
</div>


<!-- # https://stackoverflow.com/questions/31753897/2-column-section-in-r-markdown -->
<style>
.column-left{
  float: left;
  width: 49.2%;
  text-align: left;
}
<!-- .column-center{ -->
<!--   display: inline-block; -->
<!--   width: 33%; -->
<!--   text-align: center; -->
<!-- } -->
.column-right{
  float: right;
  width: 49.2%;
  text-align: left;
}
.row:after { content: ""; display: table; clear: both; }
</style>

<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>
